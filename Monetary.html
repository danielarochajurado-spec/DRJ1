<!DOCTYPE html> <html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HypotheticalDDgame</title>
  <script src="https://unpkg.com/jspsych@7.2.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.1"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://unpkg.com/jspsych@7.2.1/css/jspsych.css" rel="stylesheet" />

  <style>
    body { background: #0f1220; color: white; font-family: Arial, Helvetica, sans-serif; margin: 0; }
    #jspsych-target { min-height: 100vh; display:flex; align-items:center; justify-content:center; }
    .jspsych-content { max-width: 800px; text-align:center; font-size:18px; padding: 40px; }
    button.jspsych-btn { padding: 14px 22px; font-size:18px; border-radius:10px; border: none; cursor:pointer; margin:10px; }
    .left-btn { background:darkgray; color:black; }
    .right-btn { background:darkgray; color:black; }
    #saveExitBtn {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 10001; 
        cursor: pointer;
        background: transparent;
        color: black;
        border: 1px solid #283056;
        border-radius: 10px;
        padding: 10px 12px;
    }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>
   <button id="saveExitBtn"> Salvar e sair </button>

<script type="module">
  // ===== FIREBASE IMPORT =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // ===== FIREBASE CONFIG =====
  const firebaseConfig = {   
    apiKey: "AIzaSyBdiRWxsnpS55ZhgVAMR89FP7DTXOQ4WiA",
    authDomain: "discountinggame.firebaseapp.com",
    projectId: "discountinggame",
    storageBucket: "discountinggame.firebasestorage.app",
    messagingSenderId: "497209908113",
    appId: "1:497209908113:web:6e36f40f63b8154a44d830"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  window.db = db;
 
  // ===== FUNCIONES FIREBASE =====
    function exportDataToExcel(participant_id) {
      const worksheet = XLSX.utils.json_to_sheet(data_rows);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Resultados');
      // Generate the filename using participant ID and date
      const date = new Date().toISOString().slice(0, 10);
      const filename = `Monetary_results_${participant_id}_${date}.xlsx`;

      // Write and download the Excel file
      XLSX.writeFile(workbook, filename);
    }
    
    async function saveDataToFirebase(participant_id, data_rows) {
        try {
          const date = new Date().toISOString().slice(0,10);
          const docId = `Monetary_${date}_${participant_id}`;
          const docRef = doc(db, "results", docId);

          await setDoc(docRef, {
            participant_id,
            date,
            data: data_rows
          });
          console.log('✅ Data successfully sent to Firestore');
         } catch (error) {
          console.error('❌ Error sending data to Firestore:', error);
        }
      }

      async function saveAndExit(jsPsych) {     
        console.log('Saving and exiting...');     
        // Retrieve the participant ID     
        let participant_id = jsPsych?.data?.get()?.values()[0]?.participant_id || localStorage.getItem('participant_id') || "unknown";      
        exportDataToExcel(participant_id);      
        await saveDataToFirebase(participant_id, data_rows);      
        // Save data to localStorage as a backup      
        localStorage.setItem('DDGame', JSON.stringify(data_rows));      
        // Redirect or show a confirmation message      
        alert('Your progress has been saved. The game will now end.');      
        window.location.href = "index.html"; // Redirect to the main page or a thank-you page
        }    
        window.saveAndExit = saveAndExit; // Hacer accesible globalmente

      async function markTaskComplete() {
        const pid = localStorage.getItem('participantId');
        const taskId = localStorage.getItem('currentTask');
        const ref = doc(db, "participants", pid);
        const snap = await getDoc(ref);
        let data = snap.exists() ? snap.data() : { completed: {} };

        data.completed[taskId] = true;
        await setDoc(ref, data);
      }
      window.markTaskComplete = markTaskComplete;
      document.addEventListener('gameComplete', markTaskComplete);


  // ============================
  // Inicializar jsPsych
  // ============================
  const jsPsych = initJsPsych({
    display_element: 'jspsych-target',
    override_safe_mode: true,      
        on_finish: async () => {
          let participant_id = jsPsych?.data?.get()?.values()[0]?.participant_id || localStorage.getItem('participant_id') || "unknown";
          exportDataToExcel(participant_id);
          await saveDataToFirebase(participant_id, data_rows);
          await markTaskComplete();
          window.location.href = "index.html";
        }
  });

  let jsPsychInstance; // Variable global para almacenar la instancia de jsPsych

  const saveExitBtn = document.createElement('button');
  saveExitBtn.id = 'saveExitBtn';
  saveExitBtn.textContent = 'Salvar e sair';
  saveExitBtn.style.position = 'fixed';
  saveExitBtn.style.top = '10px';
  saveExitBtn.style.right = '10px';
  saveExitBtn.style.zIndex = '10001';
  saveExitBtn.style.backgroundColor = 'transparent';
  saveExitBtn.style.color = 'white';
  saveExitBtn.style.padding = '10px 20px';
  saveExitBtn.style.borderRadius = '8px';
  saveExitBtn.style.cursor = 'pointer';
  saveExitBtn.onclick = () => saveAndExit(jsPsych); // Usar la instancia global
  document.body.appendChild(saveExitBtn);

  // ============================
  // BuildInitialTrials: ID + instrucciones

const fixed_delay = ["1 mês", "6 meses", "1 ano", "2 anos", "5 anos", "10 anos"]; // atrasos fixos
const fixed_immediate = "imediatamente";
const A_l = 1000;  // valor inicial grande
const stepSize_initial = 50;
let stepSize = stepSize_initial;
const data_rows = [];

// ============================
// Funções iniciais
// ============================

function buildInitialTrials(jsPsych_instance) {
  const participant_id_trial = {
    type: jsPsychSurveyText,
    questions: [{
      prompt: '<h2>Bem-vindo ao experimento</h2><p>Se você já leu e assinou o termo de consentimento, insira seu número de participante para começar.</p>',
      placeholder: 'Ex: 101',
      required: true,
      name: 'participant_id'
    }],
    on_finish: (data) => {
      const participant_id = data.response.participant_id;
      if (participant_id) {
        jsPsych_instance.data.addProperties({ participant_id });
        localStorage.setItem('participant_id', participant_id);
      }
    }
  };

  const instructions = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `<h2>Instruções</h2>
      <p>
      Imagine que você está participando de um jogo de escolhas.
      Durante esta tarefa, você verá várias perguntas do tipo: <em>“O que você prefere?”</em>, seguidas de duas opções de escolha.
      As opções descrevem receber uma quantia de dinheiro em diferentes momentos no tempo.
      Não haverá jogo real — apenas registraremos suas preferências.<br><br>
      Responda como se realmente estivesse fazendo essas escolhas.
      </p>
      <p>
      Clique em “Começar” para iniciar.
      </p>`,
    choices: ['Começar'],
  };

  return [participant_id_trial, instructions];
}

// ============================
// Pausa em branco (ITI 0.5s)
// ============================

const blank_screen = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: '',
  choices: "NO_KEYS",
  trial_duration: 500,
  data: { trial_type: 'blank' }
};

// ============================
// freeTrial: ajusta valor (amountState.large)
// ============================

function freeTrial(amountState, current_delay, condition_index, response_type, trial_number_tracker, p_tracker) {
  return {
    type: jsPsychHtmlButtonResponse,
    stimulus: () => `
      <div style="margin-bottom:20px;">
        <p><strong>O que você prefere?</strong></p>
      </div>
    `,
    choices: () => [
      `Ganhar R$ ${amountState.large.toFixed(0)} ${fixed_immediate}`,
      `Ganhar R$ ${A_l.toFixed(0)} em ${current_delay}`
    ],
    button_html: [
      `<button class="jspsych-btn left-btn">%choice%</button>`,
      `<button class="jspsych-btn right-btn">%choice%</button>`
    ],
    on_finish: (data) => {
      const choice = data.response === 0 ? 'left' : 'right';
      const choice_num = data.response === 0 ? 1 : 2;

      response_type.push(choice);
      trial_number_tracker.count++;

      // histórico de escolhas
      if (!p_tracker.last_two) p_tracker.last_two = [];
      p_tracker.last_two.push(choice);

      // ajusta valor grande
      if (choice === 'left') {
        amountState.large = Math.max(50, amountState.large - stepSize);
      } else {
        amountState.large = Math.min(A_l, amountState.large + stepSize);
      }

      // rastreia mudanças de preferência
      if (p_tracker.last !== null) {
        if (choice !== p_tracker.last) p_tracker.p_changes++;
        else if (choice === 'right') p_tracker.no_change++;
      }
      p_tracker.last = choice;

      // salva dados
      const last_choice_data = {
        condition: current_delay,
        A_large: amountState.large,
        A_small: A_l,
        choice: choice,
        choice_num: choice_num,
        delay_large: current_delay,
        delay_small: fixed_immediate,
        latency: data.rt,
        trial_number: trial_number_tracker.count
      };
      data_rows.push(last_choice_data);
      console.log('Trial data:', last_choice_data);
    }
  };
}

// ============================
// Placeholders (sem esperas reais)
// ============================

function createDelay() {
  return {
    type: jsPsychHtmlButtonResponse,
    stimulus: () => `<div style="height:1px;"></div>`,
    choices: [],
    trial_duration: 0,
    data: { trial_type: 'delay_placeholder' }
  };
}

// ============================
// BuildConditionsLoop
// ============================

function buildConditionsLoop() {
  const condition_timelines = [];

  for (let i = 0; i < fixed_delay.length; i++) {
    const current_delay = fixed_delay[i];
    const amountState_local = { large: A_l };
    const response_type_local = [];
    const trial_number_tracker_local = { count: 0 };
    const p_tracker_local = { p_changes: 0, no_change: 0, last: null };
    let loop_counter = 0;

    const loop_timeline = {
      timeline: [
        freeTrial(amountState_local, current_delay, i, response_type_local, trial_number_tracker_local, p_tracker_local),
        blank_screen
      ],
      loop_function: function(data) {
        loop_counter++;
        console.log(`Loop ${loop_counter} para atraso ${current_delay} (valor ajustado: ${amountState_local.large})`);

        const stop = (
          (p_tracker_local.p_changes > 2) ||
          (p_tracker_local.no_change > 6) ||
          (response_type_local.length >= 15)
        );

        return !stop;
      },
      on_timeline_finish: function() {
        console.log(`Condição finalizada para ${current_delay}. Valor ajustado final: R$ ${amountState_local.large.toFixed(0)}`);
      }
    };

    condition_timelines.push(loop_timeline);
  }

  return condition_timelines;
}

// ============================
// Mensagem final
// ============================

const final_message = {
  type: jsPsychHtmlButtonResponse,
  stimulus: () => `<p>Tarefa finalizada!</p><p>Obrigada pela sua participação</p>`,
  choices: ['Fechar']
};

// ============================
// Main timeline
// ============================


const main_timeline = [
  ...buildInitialTrials(jsPsych),
  ...buildConditionsLoop(),
  final_message
];

jsPsych.run(main_timeline);

</script>
</html>
